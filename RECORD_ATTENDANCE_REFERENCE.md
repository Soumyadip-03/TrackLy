# Record Attendance - Implementation Reference

## Current File Structure

### Frontend Components
- **Path**: `frontend/components/attendance/visual-attendance-form.tsx`
- **Status**: Empty (ready for redesign)
- **Purpose**: Main attendance recording interface

### Related Components
- `frontend/components/attendance/attendance-calculator.tsx` - Calculate attendance percentages
- `frontend/components/attendance/target-attendance-calculator.tsx` - Plan future attendance
- `frontend/components/attendance/attendance-calendar.tsx` - Calendar component
- `frontend/components/attendance/multi-date-subject-selector.tsx` - Multi-date selector
- `frontend/components/attendance/holiday-manager.tsx` - Holiday management

### Page Routes
- **Main Page**: `frontend/app/(main)/attendance/page.tsx`
- **Tabs**: Record Attendance | Attendance Calculator

## Backend API Routes

### Schedule API
- **GET** `/api/schedule` - Fetch user's schedule
- **POST** `/api/schedule` - Save/update schedule
- **DELETE** `/api/schedule` - Clear schedule

### Attendance API
- **POST** `/api/attendance/whole-day` - Mark all classes for a day
- **POST** `/api/attendance/per-subject` - Mark single subject
- **GET** `/api/attendance/stats` - Get attendance statistics
- **GET** `/api/attendance/history` - Get attendance history
- **GET** `/api/attendance/range` - Get attendance by date range
- **GET** `/api/attendance/records` - Get schedule-based records
- **POST** `/api/attendance/records` - Save schedule-based records

### Subject API
- **GET** `/api/subject` - Get all subjects
- **POST** `/api/subject` - Create subject

## Data Models

### Schedule Model
```javascript
{
  userId: ObjectId,
  academicPeriodId: ObjectId,
  userName: String,
  userSemester: Number,
  scheduleId: String,
  schedule: {
    classes: [{
      id: String,
      day: String,
      subject: String,
      classType: String,
      startTime: String,
      endTime: String,
      building: String,
      room: String
    }],
    offDays: [String]
  }
}
```

### Attendance Model
```javascript
{
  user: ObjectId,
  subject: ObjectId,
  date: Date,
  status: 'present' | 'absent',
  calculationType: 'wholeDay' | 'perSubject'
}
```

### AttendanceRecord Model (Schedule-based)
```javascript
{
  id: String,
  date: String,
  classId: String,
  className: String,
  classType: String,
  status: 'present' | 'absent',
  notes: String,
  isAutoGenerated: Boolean,
  subjectId: String
}
```

### Subject Model
```javascript
{
  name: String,
  code: String,
  classType: String,
  semester: Number,
  totalClasses: Number,
  attendedClasses: Number,
  user: ObjectId,
  schedule: [{
    day: String,
    startTime: String,
    endTime: String
  }]
}
```

## Key Features to Implement

### 1. Calendar Selection
- Date picker
- Show today's date
- Display scheduled classes count
- Show off days

### 2. Class Display
- List all classes for selected date
- Show class details (name, type, time, room)
- Visual status indicators (present/absent/unmarked)
- Click to select class

### 3. Attendance Recording
- Mark individual class (present/absent)
- Quick actions (mark all present/absent)
- Add notes (optional)
- Save to database

### 4. Auto-Marking Logic
- Auto-mark past classes as present
- Visual indication (blue cards)
- Trigger on viewing past dates
- Background interval check

### 5. Notifications
- Low attendance warning (< 75%)
- Points deduction alerts
- Break reminders (15 min before)
- Daily class reminders
- Daily summary email

### 6. Email Preferences
- Daily class reminders toggle
- Break notifications toggle
- Low attendance alerts toggle
- Daily summary toggle
- Email input and save

## Utilities & Services

### Storage Utils
- **Path**: `frontend/lib/storage-utils.ts`
- `saveToLocalStorage(key, value)`
- `getFromLocalStorage(key, defaultValue)`

### Attendance Service
- **Path**: `frontend/lib/services/attendance-service.ts`
- `getAll()` - Fetch all records
- `save(records)` - Save records

### API Utils
- **Path**: `frontend/lib/api.ts`
- `fetchWithAuth(endpoint, options)` - Authenticated API calls

### Email Utils
- **Path**: `frontend/lib/email-utils.ts`
- `sendEmail(subject, body, recipient)`
- `sendDailySummary(date, records, todos)`
- `saveEmailPreferences(preferences)`

## Notification System

### Thresholds
- **Attendance Warning**: 75% (configurable)
- **Break Reminder**: 15 minutes before
- **Points Deduction**: -2 per absence/calculator use

### Notification Types
1. Low Attendance Warning (alert, high priority)
2. Points Deduction (alert, medium/low priority)
3. Break Reminders (info, medium priority)
4. Daily Class Reminders (info, low priority)
5. Auto-Marked Notification (info, low priority)

## Points System
- **Initial Points**: 100
- **Absent (whole day)**: -2 per subject
- **Per-subject calculator**: -2 per use
- **Storage**: User model, localStorage

## Calculation Logic

### Attendance Percentage
```
percentage = (attendedClasses / totalClasses) × 100
```

### Classes to Attend (if below target)
```
classesNeeded = ceil((target% × total - attended) / (1 - target%))
```

### Classes Can Skip (if above target)
```
canSkip = floor((attended - target% × total) / target%)
```

## Data Flow

### Recording Attendance
1. User selects date from calendar
2. Fetch schedule from API (`/api/schedule`)
3. Filter classes for selected day
4. Display classes with current status
5. User selects class and status
6. Save to localStorage + API (`/api/attendance/records`)
7. Update subject stats (`totalClasses`, `attendedClasses`)
8. Check thresholds and send notifications
9. Deduct points if absent
10. Dispatch `attendanceUpdated` event

### Loading Data
1. Component mounts
2. Fetch schedule from API (fallback to localStorage)
3. Fetch attendance records from service
4. Update state with schedule and records
5. Listen for `scheduleUpdated` and `attendanceUpdated` events

## UI Components Needed

### From shadcn/ui
- Card, CardContent
- Calendar
- Button, LoadingButton
- Label
- Input, Textarea
- Badge
- Tooltip
- Tabs, TabsList, TabsTrigger, TabsContent
- Select, SelectContent, SelectItem, SelectTrigger, SelectValue
- Popover, PopoverContent, PopoverTrigger

### Custom Components
- VisualAttendanceForm (main component)
- AttendanceCalculator
- TargetAttendanceCalculator
- NotificationPopup
- ToastNotification

## Environment Variables

### Frontend (.env.local)
```
NEXT_PUBLIC_API_URL=http://localhost:5000/api
```

### Backend (config.env)
```
MONGODB_URI=mongodb+srv://...
PORT=5000
FRONTEND_URL=http://localhost:3000
JWT_SECRET=...
EMAIL_SERVICE=gmail
EMAIL_USER=...
EMAIL_PASSWORD=...
```

## Event System

### Custom Events
- `scheduleUpdated` - Fired when schedule changes
- `attendanceUpdated` - Fired when attendance is recorded
- `storage` - Native browser event for localStorage changes

### Event Listeners
```javascript
window.addEventListener('scheduleUpdated', loadData)
window.addEventListener('attendanceUpdated', loadData)
window.addEventListener('storage', handleStorageChange)
```

## Future Considerations

### Features to Add
- Bulk edit attendance
- Export attendance reports (PDF/CSV)
- Attendance analytics dashboard
- Attendance predictions using AI
- Calendar integration (Google Calendar, Outlook)
- Mobile app support
- Offline mode with sync queue
- Undo/redo functionality

### Performance Optimizations
- Lazy load attendance records
- Paginate history
- Cache API responses
- Debounce auto-save
- Virtual scrolling for large lists

### Security Enhancements
- Rate limiting on API
- Input validation
- XSS protection
- CSRF tokens
- Secure email handling

## Testing Checklist

### Unit Tests
- [ ] Attendance calculation logic
- [ ] Date filtering
- [ ] Status toggle logic
- [ ] Points calculation

### Integration Tests
- [ ] API endpoints
- [ ] Database operations
- [ ] Email sending
- [ ] Notification creation

### E2E Tests
- [ ] Complete attendance flow
- [ ] Calendar navigation
- [ ] Bulk marking
- [ ] Email preferences

## Known Issues & Limitations

1. Auto-marking only works when viewing past dates (no real-time trigger)
2. Auto-marked records only save to localStorage (not synced to DB)
3. Dependency tracking issues in useEffect
4. No offline sync queue implementation
5. Email notifications require manual trigger
6. Break reminders only work for today's date
7. No validation for duplicate attendance records

## Migration Notes

### From Old to New Design
1. Backup current localStorage data
2. Update component structure
3. Migrate data format if needed
4. Test all workflows
5. Update documentation

---

**Last Updated**: January 2026
**Status**: Ready for redesign
**Next Steps**: Implement new design based on requirements
